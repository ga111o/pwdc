#!/bin/bash
# pwdc - Copy current directory to clipboard

# Get current directory
current_dir=$(pwd)

# Handle arguments
if [ -n "$1" ]; then
    if [ "$1" = "." ]; then
        # Only "." - copy directory name only
        current_dir=$(basename "$current_dir")
    else
        # Path argument - append to current directory
        # Remove leading "./" if present
        path_arg="${1#./}"
        current_dir="$current_dir/$path_arg"
    fi
fi

# Function to copy using OSC 52 escape sequence
copy_osc52() {
    local str="$1"
    local b64
    if command -v base64 >/dev/null 2>&1; then
        b64=$(echo -n "$str" | base64 | tr -d '\n')
    elif command -v openssl >/dev/null 2>&1; then
        b64=$(echo -n "$str" | openssl base64 | tr -d '\n')
    else
        return 1
    fi

    # OSC 52 sequence
    local esc_seq="\033]52;c;$b64\007"

    # Wrap for tmux or screen if necessary
    if [ -n "$TMUX" ]; then
        # tmux wrap
        printf "\033Ptmux;\033$esc_seq\033\\"
    elif [[ "$TERM" == screen* ]]; then
        # screen wrap (DCS sequence)
        printf "\033P\033$esc_seq\033\\"
    else
        printf "$esc_seq"
    fi
    return 0
}

# Detect environment and copy
copied=false

# Try SSH/OSC 52 first if in SSH session
if [ -n "$SSH_TTY" ] || [ -n "$SSH_CLIENT" ] || [ -n "$SSH_CONNECTION" ]; then
    if copy_osc52 "$current_dir"; then
        echo "Copied to clipboard (OSC 52/SSH): $current_dir"
        copied=true
    fi
fi

# Try local clipboard tools if not copied yet
if [ "$copied" = false ]; then
    if grep -qi microsoft /proc/version 2>/dev/null || [ -n "$WSL_DISTRO_NAME" ]; then
        # WSL2 environment
        if echo -n "$current_dir" | clip.exe 2>/dev/null; then
            echo "Copied to clipboard (WSL2): $current_dir"
            copied=true
        fi
    elif [ -n "$WAYLAND_DISPLAY" ] && command -v wl-copy >/dev/null 2>&1; then
        # Wayland environment
        if echo -n "$current_dir" | wl-copy; then
            echo "Copied to clipboard (Wayland): $current_dir"
            copied=true
        fi
    elif [ -n "$DISPLAY" ] && command -v xclip >/dev/null 2>&1; then
        # X11 with xclip
        if echo -n "$current_dir" | xclip -selection clipboard; then
            echo "Copied to clipboard (X11): $current_dir"
            copied=true
        fi
    elif [ -n "$DISPLAY" ] && command -v xsel >/dev/null 2>&1; then
        # X11 with xsel
        if echo -n "$current_dir" | xsel --clipboard; then
            echo "Copied to clipboard (X11): $current_dir"
            copied=true
        fi
    elif command -v pbcopy >/dev/null 2>&1; then
        # macOS
        if echo -n "$current_dir" | pbcopy; then
            echo "Copied to clipboard (macOS): $current_dir"
            copied=true
        fi
    fi
fi

# Final fallback to OSC 52 (works in many modern terminals locally)
if [ "$copied" = false ]; then
    if copy_osc52 "$current_dir"; then
        echo "Copied to clipboard (OSC 52): $current_dir"
        copied=true
    else
        echo "Error: No clipboard utility found. Please install xclip, wl-clipboard, or ensure base64 is available."
        exit 1
    fi
fi
